
pipeline {
    agent any
    stages {
        stage("pem  premissions update") {
            steps {
                sh """
                  chmod 600 /var/jenkins_home/secrets/testing.pem
                  chown jenkins:jenkins /var/jenkins_home/secrets/testing.pem
                  """
            }
       }
    //     stage("update k8s from git") {
    //         steps {
    //             sh """
    //             # ssh -i /var/jenkins_home/secrets/testing.pem ubuntu@3.70.39.129 kubectl "cd /home/ubuntu/social-media-scraper && git pull"
    //             date
    //               """
    //         }
    //    }

        stage("check k8s state") {
            steps {
                echo "====++++executing A++++===="
                sh """
                ssh -i /var/jenkins_home/secrets/testing.pem ubuntu@3.70.39.129 \
                "kubectl get svc \
                && date \
                && pwd"
                """
            }
       }                

        stage("k8s kubectl apply all") {
            steps {
                // echo "====k8s kubectl apply all===="

                sh """
                ssh -i /var/jenkins_home/secrets/testing.pem ubuntu@3.70.39.129 \
                "kubectl apply -f /home/ubuntu/social-media-scraper/kubernetes/vol-db-pvc.yaml \
                && kubectl apply -f /home/ubuntu/social-media-scraper/kubernetes/configmap.yaml \
                && kubectl apply -f /home/ubuntu/social-media-scraper/kubernetes/deployment-db.yaml \
                && kubectl apply -f /home/ubuntu/social-media-scraper/kubernetes/deployment-backend.yaml \
                && kubectl apply -f /home/ubuntu/social-media-scraper/kubernetes/deployment-frontend.yaml \
                && kubectl apply -f /home/ubuntu/social-media-scraper/kubernetes/service-db.yaml \
                && kubectl apply -f /home/ubuntu/social-media-scraper/kubernetes/service-backend.yaml \
                && kubectl apply -f /home/ubuntu/social-media-scraper/kubernetes/service-frontend.yaml" 
                """

                // sh """
                //     ssh -i /var/jenkins_home/secrets/testing.pem ubuntu@3.70.39.129 \
                //     kubectl patch svc kubernetes -p '{"spec": {"externalIPs": ["10.96.0.1"]}}'

                // """
                sh "pwd"
            }    
        }
        stage("check k8s state after apply") {
            steps {
                echo "====++++executing A++++===="
                sh """
                ssh -i /var/jenkins_home/secrets/testing.pem ubuntu@3.70.39.129 \
                "kubectl get svc"
                """
            }
       }  
    }
    post{
        always{
            echo "====++++always++++===="
            cleanWs()
        }
    }   
}